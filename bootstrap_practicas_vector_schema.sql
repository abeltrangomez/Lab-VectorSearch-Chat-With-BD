-- ============================================================
-- BOOTSTRAP COFORMACION + TRIGGERS de embeddings)
-- Requisito: modelo 'minilm_l12_v2' cargado en USER_MINING_MODELS
-- ============================================================

-- 0) Limpieza idempotente
BEGIN EXECUTE IMMEDIATE 'DROP VIEW v_match_vacante_estudiante'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TRIGGER trg_estudiante_vec'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TRIGGER trg_vacante_vec'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE estudiante_vacante PURGE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE vacantes_empresas PURGE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE estudiante PURGE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE empresa PURGE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- 1) Tablas

CREATE TABLE empresa (
  nit_empresa     VARCHAR2(20) PRIMARY KEY,
  nombre_empresa  VARCHAR2(200) NOT NULL,
  sector          VARCHAR2(100),
  ciudad          VARCHAR2(100),
  email_contacto  VARCHAR2(200)
);

CREATE TABLE vacantes_empresas (
  id_vacante             NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nit_empresa            VARCHAR2(20) NOT NULL,
  fecha_apertura_vacante DATE NOT NULL,
  fecha_cierre_vacante   DATE,
  descripcion_perfil     VARCHAR2(400) NOT NULL,
  perfil_vec             VECTOR,
  CONSTRAINT fk_vac_empresa
    FOREIGN KEY (nit_empresa) REFERENCES empresa(nit_empresa)
);

CREATE TABLE estudiante (
  id_estudiante        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tipodoc              VARCHAR2(2)  NOT NULL CHECK (tipodoc IN ('CC','TI')),
  numerodoc            VARCHAR2(30) NOT NULL,
  nombre               VARCHAR2(100) NOT NULL,
  apellidos            VARCHAR2(100) NOT NULL,
  telefono             VARCHAR2(30),
  estado_practica      VARCHAR2(40) NOT NULL CHECK (
    estado_practica IN ('EN ENTREVISTAS','NO CUMPLE CRITERIOS ACADEMICOS','ACEPTADO POR EMPRESA')
  ),
  estado_academico     VARCHAR2(10) NOT NULL CHECK (estado_academico IN ('ACTIVO','INACTIVO')),
  perfil_profesional   VARCHAR2(400) NOT NULL,
  perfil_vec           VECTOR,
  CONSTRAINT uq_est_doc UNIQUE (tipodoc, numerodoc)
);

CREATE TABLE estudiante_vacante (
  id_postulacion  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  id_estudiante   NUMBER NOT NULL,
  id_vacante      NUMBER NOT NULL,
  fecha_post      DATE DEFAULT SYSDATE NOT NULL,
  estado_post     VARCHAR2(20) DEFAULT 'POSTULADO' NOT NULL,
  CONSTRAINT fk_ev_est FOREIGN KEY (id_estudiante) REFERENCES estudiante(id_estudiante),
  CONSTRAINT fk_ev_vac FOREIGN KEY (id_vacante) REFERENCES vacantes_empresas(id_vacante),
  CONSTRAINT uq_ev UNIQUE (id_estudiante, id_vacante)
);

-- 2) Triggers (ahora sí se permite UPDATE OF porque NO es CLOB)

CREATE OR REPLACE TRIGGER trg_estudiante_vec
BEFORE INSERT OR UPDATE OF perfil_profesional
ON estudiante
FOR EACH ROW
BEGIN
  -- Genera embedding cuando se inserta o cambia el perfil
  SELECT VECTOR_EMBEDDING(minilm_l12_v2 USING :NEW.perfil_profesional AS data)
    INTO :NEW.perfil_vec
    FROM dual;

EXCEPTION
  WHEN OTHERS THEN
    RAISE_APPLICATION_ERROR(
      -20001,
      'Error generando embedding en TRG_ESTUDIANTE_VEC. Verifica modelo MINILM_L12_V2. Detalle: ' || SQLERRM
    );
END;
/
-- (Si tu herramienta no soporta SHOW ERRORS, ignóralo)
SHOW ERRORS
/

CREATE OR REPLACE TRIGGER trg_vacante_vec
BEFORE INSERT OR UPDATE OF descripcion_perfil
ON vacantes_empresas
FOR EACH ROW
BEGIN
  SELECT VECTOR_EMBEDDING(minilm_l12_v2 USING :NEW.descripcion_perfil AS data)
    INTO :NEW.perfil_vec
    FROM dual;

EXCEPTION
  WHEN OTHERS THEN
    RAISE_APPLICATION_ERROR(
      -20002,
      'Error generando embedding en TRG_VACANTE_VEC. Verifica modelo MINILM_L12_V2. Detalle: ' || SQLERRM
    );
END;
/
SHOW ERRORS
/

-- 3) Datos base (los triggers llenan perfil_vec automáticamente)

-- 3.1 Empresas
INSERT INTO empresa VALUES ('900100100-1','DataNova SAS','Tecnología','Bogotá','talento@datanova.co');
INSERT INTO empresa VALUES ('900200200-2','Fintech Andina','Finanzas','Medellín','hr@fintechandina.com');
INSERT INTO empresa VALUES ('900300300-3','SecureLab LTDA','Ciberseguridad','Cali','jobs@securelab.io');
INSERT INTO empresa VALUES ('900400400-4','CloudWare','Software','Barranquilla','reclutamiento@cloudware.dev');
INSERT INTO empresa VALUES ('900500500-5','Retail Insights','Retail','Bogotá','seleccion@retailinsights.com');

-- 3.2 Vacantes (10) - OJO: máx 400 chars por registro
INSERT INTO vacantes_empresas (nit_empresa,fecha_apertura_vacante,fecha_cierre_vacante,descripcion_perfil) VALUES
('900100100-1', DATE '2026-02-01', DATE '2026-03-15', 'Data Analyst: SQL, Power BI, ETL básico, dashboards, comunicación.');
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900100100-1', DATE '2026-02-10', DATE '2026-03-20', 'Data Engineer: pipelines, modelado, Spark básico, Python, Git.', NULL);
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900200200-2', DATE '2026-02-05', DATE '2026-03-05', 'Backend Java: Spring Boot, APIs REST, pruebas, PostgreSQL, seguridad básica.', NULL);
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900200200-2', DATE '2026-02-08', DATE '2026-03-18', 'BI: Power BI, DAX, SQL, levantamiento de requerimientos.', NULL);
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900300300-3', DATE '2026-02-03', DATE '2026-03-25', 'Ciberseguridad: Linux, OWASP, redes, SIEM básico, reportes.', NULL);
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900300300-3', DATE '2026-02-12', DATE '2026-03-30', 'Pentesting web junior: Burp Suite, vulnerabilidades web, documentación.', NULL);
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900400400-4', DATE '2026-02-01', DATE '2026-03-10', 'DevOps junior: Docker, CI/CD, Kubernetes básico, monitoreo, scripting.', NULL);
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900400400-4', DATE '2026-02-15', DATE '2026-04-01', 'Frontend React: TypeScript, UI/UX, consumo de APIs, pruebas.', NULL);
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900500500-5', DATE '2026-02-04', DATE '2026-03-22', 'Ciencia de datos: estadística, Python, pandas, ML básico, visualización, SQL.', NULL);
INSERT INTO vacantes_empresas VALUES
(DEFAULT,'900500500-5', DATE '2026-02-06', DATE '2026-03-28', 'Product/UX: investigación, Figma, prototipos, métricas, priorización.', NULL);

-- 3.3 Estudiantes (20) - OJO: máx 400 chars por registro
INSERT INTO estudiante (tipodoc,numerodoc,nombre,apellidos,telefono,estado_practica,estado_academico,perfil_profesional) VALUES
('CC','10000001','Laura','Gómez Ruiz','3001110001','EN ENTREVISTAS','ACTIVO','Python, SQL, ETL, Power BI, analítica de datos.');
INSERT INTO estudiante VALUES (DEFAULT,'TI','20000002','Mateo','Hernández Pico','3001110002','EN ENTREVISTAS','ACTIVO','Java, Spring Boot, APIs REST, PostgreSQL, pruebas unitarias.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000003','Sofía','Martínez Díaz','3001110003','ACEPTADO POR EMPRESA','ACTIVO','Ciberseguridad: Linux, redes, OWASP, SIEM básico, Bash.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000004','Juan','Rojas Castillo','3001110004','NO CUMPLE CRITERIOS ACADEMICOS','INACTIVO','Soporte TI: mesa de ayuda, Windows, Office, atención al usuario.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'TI','20000005','Valentina','Torres Núñez','3001110005','EN ENTREVISTAS','ACTIVO','NLP, embeddings, RAG, Python, bases de datos.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000006','Daniel','Sánchez Vera','3001110006','EN ENTREVISTAS','ACTIVO','Frontend: React, TypeScript, UI/UX, consumo de APIs.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000007','Camila','Navarro Gil','3001110007','ACEPTADO POR EMPRESA','ACTIVO','Data engineering: pipelines, modelado dimensional, SQL, Spark básico.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'TI','20000008','Andrés','Moreno León','3001110008','EN ENTREVISTAS','ACTIVO','DevOps: Docker, CI/CD, Kubernetes básico, observabilidad.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000009','Mariana','Prieto Solano','3001110009','EN ENTREVISTAS','ACTIVO','QA: pruebas funcionales, Selenium, documentación.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000010','Sebastián','Londoño Vélez','3001110010','EN ENTREVISTAS','ACTIVO','Node.js, Express, MongoDB, PostgreSQL, JWT.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'TI','20000011','Isabella','Cárdenas Ochoa','3001110011','ACEPTADO POR EMPRESA','ACTIVO','BI: Power BI, DAX, SQL, requerimientos, storytelling.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000012','Nicolás','Pérez Salazar','3001110012','EN ENTREVISTAS','ACTIVO','Machine learning: scikit-learn, clasificación, validación.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000013','Gabriela','Acosta Ríos','3001110013','EN ENTREVISTAS','ACTIVO','Nube y datos: OCI/AWS básico, object storage, orquestación.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'TI','20000014','Samuel','Quintero Pardo','3001110014','EN ENTREVISTAS','ACTIVO','PL/SQL, modelado relacional, índices, tuning básico.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000015','Luciana','Vargas Peña','3001110015','EN ENTREVISTAS','ACTIVO','Full stack: React + Java, microservicios, pruebas.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000016','Emiliano','Beltrán Hoyos','3001110016','NO CUMPLE CRITERIOS ACADEMICOS','ACTIVO','Infraestructura: redes, inventarios, mantenimiento.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'TI','20000017','Sara','Mendoza Rangel','3001110017','EN ENTREVISTAS','ACTIVO','Estadística, Python, pandas, visualización, SQL.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000018','Tomás','Ariza Camacho','3001110018','EN ENTREVISTAS','ACTIVO','Pentesting web: Burp Suite, reporte, ética profesional.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'CC','10000019','Paula','Ortega Fajardo','3001110019','ACEPTADO POR EMPRESA','ACTIVO','Product/UX: investigación, Figma, prototipos, métricas.', NULL);
INSERT INTO estudiante VALUES (DEFAULT,'TI','20000020','David','Ramírez Cuéllar','3001110020','EN ENTREVISTAS','ACTIVO','Ingeniería de software: clean code, Java/Python, APIs, SQL.', NULL);

-- 3.4 Asociaciones ejemplo (10)
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (1, 1);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (7, 2);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (2, 3);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (11,4);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (3, 5);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (18,6);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (8, 7);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (6, 8);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (17,9);
INSERT INTO estudiante_vacante (id_estudiante, id_vacante) VALUES (19,10);

COMMIT;

-- 4) View para APEX (vacante -> ranking estudiantes)
CREATE OR REPLACE VIEW v_match_vacante_estudiante AS
SELECT
  v.id_vacante,
  v.nit_empresa,
  e.id_estudiante,
  e.nombre,
  e.apellidos,
  e.estado_academico,
  e.estado_practica,
  VECTOR_DISTANCE(e.perfil_vec, v.perfil_vec, COSINE) AS distancia
FROM vacantes_empresas v
JOIN estudiante e
  ON e.estado_academico = 'ACTIVO'
 AND e.estado_practica <> 'NO CUMPLE CRITERIOS ACADEMICOS'
WHERE v.perfil_vec IS NOT NULL
  AND e.perfil_vec IS NOT NULL;

-- 5) Verificación mínima
SELECT COUNT(*) AS empresas FROM empresa;
SELECT COUNT(*) AS vacantes FROM vacantes_empresas;
SELECT COUNT(*) AS estudiantes FROM estudiante;

SELECT COUNT(*) AS estudiantes_total,
       SUM(CASE WHEN perfil_vec IS NOT NULL THEN 1 ELSE 0 END) AS estudiantes_con_vector
FROM estudiante;

SELECT COUNT(*) AS vacantes_total,
       SUM(CASE WHEN perfil_vec IS NOT NULL THEN 1 ELSE 0 END) AS vacantes_con_vector
FROM vacantes_empresas;